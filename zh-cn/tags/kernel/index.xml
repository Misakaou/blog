<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Kernel on Moeomu博客</title><link>https://blog.moeomu.com/zh-cn/tags/kernel/</link><description>Recent content in Kernel on Moeomu博客</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 07 Jul 2021 11:20:00 +0800</lastBuildDate><atom:link href="https://blog.moeomu.com/zh-cn/tags/kernel/index.xml" rel="self" type="application/rss+xml"/><item><title>Linux内核学习笔记-001-编译和启动内核</title><link>https://blog.moeomu.com/zh-cn/posts/linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%BC%96%E8%AF%91%E5%92%8C%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8/</link><pubDate>Wed, 07 Jul 2021 11:20:00 +0800</pubDate><guid>https://blog.moeomu.com/zh-cn/posts/linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%BC%96%E8%AF%91%E5%92%8C%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8/</guid><description>&lt;p>本文来源：&lt;a class="link" href="https://blog.moeomu.com/zh-cn/posts/linux%e5%86%85%e6%a0%b8%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0-001-%e7%bc%96%e8%af%91%e5%92%8c%e5%90%af%e5%8a%a8%e5%86%85%e6%a0%b8/" >Moeomu的博客&lt;/a>&lt;/p>
&lt;h2 id="准备环境">准备环境&lt;/h2>
&lt;ul>
&lt;li>Ubuntu 20.04 LTS&lt;/li>
&lt;li>Linux 4.9.229&lt;/li>
&lt;li>Busybox 1.33.0&lt;/li>
&lt;li>qemu&lt;/li>
&lt;/ul>
&lt;h3 id="下载内核源代码和文件系统源代码">下载内核源代码和文件系统源代码&lt;/h3>
&lt;ul>
&lt;li>在站点&lt;a class="link" href="https://www.kernel.org" target="_blank" rel="noopener"
>Kernel.org&lt;/a>下载&lt;code>linux-4.9.229.tar.gz&lt;/code>&lt;/li>
&lt;li>在站点&lt;a class="link" href="https://www.busybox.net/downloads" target="_blank" rel="noopener"
>Busybox.net&lt;/a>下载&lt;code>busybox-1.33.0.tar.bz2&lt;/code>&lt;/li>
&lt;li>通过apt安装qemu：&lt;code>sudo apt install qemu-system-x86&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="编译">编译&lt;/h2>
&lt;h3 id="编译内核">编译内核&lt;/h3>
&lt;ul>
&lt;li>&lt;code>export ARCH=x86&lt;/code>&lt;/li>
&lt;li>&lt;code>make x86_64_defconfig&lt;/code>&lt;/li>
&lt;li>&lt;code>make menuconfig&lt;/code>
&lt;ul>
&lt;li>选中&lt;code>General Setup -&amp;gt; Initial RAM filesystem and RAM disk(initramfs/initrd) support&lt;/code>&lt;/li>
&lt;li>选中&lt;code>Device Drivers -&amp;gt; Block devices -&amp;gt; RAM block device support&lt;/code>&lt;/li>
&lt;li>修改&lt;code>Device Drivers -&amp;gt; Block devices -&amp;gt; RAM block device support -&amp;gt; (65536)default RAM disk size (kbytes)&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>如果这一步报错&lt;code>fatal error: curses.h&lt;/code>，则安装一下&lt;code>sudo apt install libncurses5-dev&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>&lt;code>make&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>编译好的内核被放置在目录&lt;code>arch/x86/boot&lt;/code>下，文件名&lt;code>bzImage&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="编译busybox">编译busybox&lt;/h3>
&lt;ul>
&lt;li>&lt;code>make menuconfig&lt;/code>
&lt;ul>
&lt;li>选中&lt;code>Settings -&amp;gt; Build Options -&amp;gt; [*] Build Busybox as a static binary (no shard libs)&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>make &amp;amp;&amp;amp; make install&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="打包文件系统">打包文件系统&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;code>mkdir etc dev mnt&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>mkdir -p proc sys tmp&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>mkdir -p etc/init.d&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>vim etc/fstab&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">proc /proc proc defaults 0 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs /tmp tmpfs defaults 0 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysfs /sys sysfs defaults 0 0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>vim etc/init.d/rcS&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;Welcome to Moeomu Linux&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/bin/mount -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;Remounting the root filesystem&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount -o remount rw /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p /dev/pts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">moutn -t devpts devpts /dev/pts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> /sbin/mdev &amp;gt; /proc/sys/kernel/hotplug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mdev -s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>chmod 755 etc/init.d/rcS&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>vim etc/inittab&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">::sysinit:/etc/init.d/rcS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::respawn:-/bin/sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::askfirst:-/bin/sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">::cttlaltdel:/bin/umount -a -r
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>chmod 755 etc/inittab&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>cd dev&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>sudo mknod console c 5 1&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>sudo mknod null c 1 3&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>sudo mknod tty1 c 4 1&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>以下代码在busybox源码目录下逐行执行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>rm -rf rootfs.ext3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dd &lt;span class="k">if&lt;/span>&lt;span class="o">=&lt;/span>/dev/zero &lt;span class="nv">of&lt;/span>&lt;span class="o">=&lt;/span>./rootfs.ext3 &lt;span class="nv">bs&lt;/span>&lt;span class="o">=&lt;/span>1M &lt;span class="nv">count&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkfs.ext3 rootfs.ext3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo mount -o loop rootfs.ext3 ./fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp -rf ./_install/* ./fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo umount ./fs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gzip --best -c rootfs.ext3 &amp;gt; rootfs.img.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>最终生成了文件系统：&lt;code>rootfs.img.gz&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="使用qemu运行系统">使用QEMU运行系统&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;code>qemu-system-x86_64 -kernel ./linux-4.9.229/arch/x86_64/boot/bzImage -initrd ./busybox-1.33.1/rootfs.img.gz -append &amp;quot;root=/dev/ram init=/linuxrc&amp;quot; -serial file:output.txt&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>预览如下&lt;/p>
&lt;p>&lt;img src="https://z3.ax1x.com/2021/07/07/RHildI.png"
loading="lazy"
alt="RHildI.png"
>&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Windows内核学习笔记-002</title><link>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-002/</link><pubDate>Fri, 18 Dec 2020 20:52:00 +0800</pubDate><guid>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-002/</guid><description>&lt;p>本文来源：&lt;a class="link" href="https://blog.moeomu.com/zh-cn/posts/windows%e5%86%85%e6%a0%b8%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0-002/" >Moeomu的博客&lt;/a>&lt;/p>
&lt;h2 id="字符串操作">字符串操作&lt;/h2>
&lt;blockquote>
&lt;p>内核中使用UNICODE_STRING结构来作为基本的字符串结构，应该注意的是使用此结构中的lenth成员确定字符串长度，而不是&lt;code>'\0'&lt;/code>。&lt;/p>
&lt;/blockquote>
&lt;h3 id="字符串初始化">字符串初始化&lt;/h3>
&lt;ul>
&lt;li>函数：&lt;code>RtlInitUnicodeString&lt;/code>&lt;/li>
&lt;li>参数：
&lt;ul>
&lt;li>&lt;code>PUNICODE_STRING&lt;/code>: &lt;code>DestinationString&lt;/code>&lt;/li>
&lt;li>&lt;code>PCWSTR&lt;/code>: &lt;code>SourceString&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>返回值：无&lt;/li>
&lt;li>IRQL：&lt;code>&amp;lt;=DISPATCH_LEVEL&lt;/code>&lt;/li>
&lt;li>解释：初始化一个以0结尾的WCHAR字符串，第一个参数是输入参数也是输出参数&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">UNICODE_STRING&lt;/span> &lt;span class="n">uFirstString&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">RtlInitUnicodeString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uFirstString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;HelloWorld&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;String:%wZ&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uFirstString&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>坑：它并没有为buffer分配空间，而是直接指向Source首地址，因此要保证Source始终有效，否则就是无效访问&lt;/p>
&lt;/blockquote>
&lt;h3 id="字符串拷贝">字符串拷贝&lt;/h3>
&lt;ul>
&lt;li>函数：&lt;code>RtlUnicodeStringCopyString&lt;/code>&lt;/li>
&lt;li>参数：
&lt;ul>
&lt;li>&lt;code>PUNICODE_STRING&lt;/code>: &lt;code>DestinationString&lt;/code>&lt;/li>
&lt;li>&lt;code>NTSTRSAFE_PCWSTR&lt;/code>: &lt;code>pszSrc&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>返回值：&lt;code>NTSTAUTS&lt;/code>
&lt;ul>
&lt;li>成功执行返回&lt;code>STATUS_SUCCESS&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>IRQL：&lt;code>=PASSIVE_LEVEL&lt;/code>&lt;/li>
&lt;li>解释：将src复制一份到dest里面&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">WCHAR&lt;/span> &lt;span class="n">strBuf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">UNICODE_STRING&lt;/span> &lt;span class="n">uFirstString&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">RtlInitEmptyUnicodeString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uFirstString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">strBuf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">strBuf&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">RtlUnicodeStringCopyString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uFirstString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;Hello Kernel&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;String: %wZ&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uFirstString&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>坑：为了使用RtlUnicodeStringCopyString函数，应该添加头文件&lt;code>Ntstrsafe.h&lt;/code>；不能copy到定长buf的String里，否则会蓝屏报内存读写错误&lt;/p>
&lt;/blockquote>
&lt;h2 id="链表">链表&lt;/h2>
&lt;h3 id="链表的定义">链表的定义&lt;/h3>
&lt;blockquote>
&lt;p>以下是wdk中链表的定义&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">_LIST_ENTRY&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">_LIST_ENTRY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">Flink&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 后节点
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">_LIST_ENTRY&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">Blink&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 前节点
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">LIST_ENTRY&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PLIST_ENTRY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="使用链表">使用链表&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">_TestListEntry&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">m_ulData1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">m_ulData2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">m_ulData3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ULONG&lt;/span> &lt;span class="n">m_ulData4&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>一般而言，为了方便操作，会定义一个链表的头结点，不包含任何内容，只是一个LIST_ENTRY结构。&lt;/li>
&lt;/ul>
&lt;h3 id="头节点初始化">头节点初始化&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">ListHeader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InitializeListHead&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="节点插入">节点插入&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">ListHeader&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">TestListEntry&lt;/span> &lt;span class="n">Entry1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">TestListEntry&lt;/span> &lt;span class="n">Entry2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">TestListEntry&lt;/span> &lt;span class="n">Entry3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Entry1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ulData1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;A&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Entry2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ulData1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;B&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Entry3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ulData1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sc">&amp;#39;C&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InitializeListHead&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InsertHeadList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">Entry2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InsertHeadList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">Entry1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InsertTailList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">Entry3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="链表遍历">链表遍历&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">PLIST_ENTRY&lt;/span> &lt;span class="n">pListEntry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">pListEntry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ListHeader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Flink&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pListEntry&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ListHeader&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PTestListEntry&lt;/span> &lt;span class="n">pTestEntry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CONTAINING_RECORD&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pListEntry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">TestListEntry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ListPtr=%p, Entry=%p, Tag=%c&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pListEntry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pTestEntry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">CHAR&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">pTestEntry&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">m_ulData1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pListEntry&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pListEntry&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">Flink&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>CONTAINING_RECORD&lt;/code>的作用是将&lt;code>m_ListEntry&lt;/code>地址转为结构体&lt;code>TestListEntry&lt;/code>首地址&lt;/li>
&lt;li>&lt;code>CONTAINING_RECORD&lt;/code>用法：&lt;code>CONTAINING_RECORD(PCHAR Address, TYPE Type, PCHAR Field)&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="节点移除">节点移除&lt;/h3>
&lt;ul>
&lt;li>移除首节点：&lt;code>PLIST_ENTRY RemoveHeadList(PLIST_ENTRY ListHead)&lt;/code>&lt;/li>
&lt;li>移除尾节点：&lt;code>PLIST_ENTRY RemoveTailList(PLIST_ENTRY ListHead)&lt;/code>&lt;/li>
&lt;li>如果成功，上面两个函数都将返回链首地址，如果无法移除，则返回NULL&lt;/li>
&lt;li>移除特定节点：
&lt;ul>
&lt;li>&lt;code>BOOLEAN RemoveEntryList(PLIST_ENTRY Entry)&lt;/code>&lt;/li>
&lt;li>若移除后变成空链表，那么将返回TRUE，如果非空，则返回FALSE&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="判断链表状态">判断链表状态&lt;/h3>
&lt;ul>
&lt;li>&lt;code>BOOLEAN IsListEmpty(const LIST_ENTRY *ListHead)&lt;/code>&lt;/li>
&lt;li>它返回TRUE时表示为空链表，否则表示链表非空&lt;/li>
&lt;/ul>
&lt;h2 id="自旋锁">自旋锁&lt;/h2>
&lt;h3 id="使用自旋锁">使用自旋锁&lt;/h3>
&lt;blockquote>
&lt;p>自旋锁是内核提供的一种高IRQL锁，用同步以及独占的方式访问某个资源&lt;/p>
&lt;p>&lt;strong>注意事项&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>自旋锁变量不能存放在当前函数栈中，否则每次进入初始化一遍跟不初始化一样&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h3 id="初始化使用自旋锁">初始化/使用自旋锁&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Initialize Spin Lock WARN: not local var
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">KSPIN_LOCK&lt;/span> &lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">KeInitializeSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// it&amp;#39;s a safe function
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Acquire Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KIRQL&lt;/span> &lt;span class="n">irql&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// save old irql
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Normal Spin Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KeAcquireSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">irql&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// TO DO
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KeReleaseSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">irql&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="自旋锁在双向链表中使用">自旋锁在双向链表中使用&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// it&amp;#39;s a safe function
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Enter...&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Acquire Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KIRQL&lt;/span> &lt;span class="n">irql&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// save old irql
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Normal Spin Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KeAcquireSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">irql&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Test List
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">_FILE_INFO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">UNICODE_STRING&lt;/span> &lt;span class="n">m_strFileName&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>&lt;span class="n">FILE_INFO&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">PFILE_INFO&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">LIST_ENTRY&lt;/span> &lt;span class="n">listHead&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">FILE_INFO&lt;/span> &lt;span class="n">my_file_info&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RtlInitUnicodeString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_file_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_strFileName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;TestName&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">InitializeListHead&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">listHead&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExInterlockedInsertHeadList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">listHead&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_file_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">m_ListEntry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">KeReleaseSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">irql&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="队列自旋锁">队列自旋锁&lt;/h3>
&lt;blockquote>
&lt;p>队列自旋锁可以在多CPU平台上有更好的性能，也遵循先等待先获取自旋锁的原则。&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>它和普通自旋锁的初始化是一样的，但是初始化后的自旋锁绝不能混用&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="n">KSPIN_LOCK&lt;/span> &lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">initLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">KeInitializeSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// it&amp;#39;s a safe function
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Acquire Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KIRQL&lt;/span> &lt;span class="n">irql&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// save old irql
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Queue Spin Lock
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">KLOCK_QUEUE_HANDLE&lt;/span> &lt;span class="n">my_lock_queue_handle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">KeAcquireInStackQueuedSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_spin_lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_lock_queue_handle&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">KeReleaseInStackQueuedSpinLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">my_lock_queue_handle&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="内存分配">内存分配&lt;/h2>
&lt;h3 id="常规内存分配">常规内存分配&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncMem&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">buffer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ExAllocatePoolWithTag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NonPagedPoolNx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">512&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">tag1&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExFreePoolWithTag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">buffer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">tag1&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Pool Operate Success!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Allocate Pool Failed!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="快表内存分配">快表内存分配&lt;/h3>
&lt;blockquote>
&lt;p>优点：高频率从系统中申请和释放内存，使用快表分配将大大提高性能&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>注意：有些地方称为“旁视列表”(LookAside)&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncMemLookaside&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PNPAGED_LOOKASIDE_LIST&lt;/span> &lt;span class="n">pLookAsideList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">bSucc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">bInit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">pSeocdeMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pLookAsideList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PNPAGED_LOOKASIDE_LIST&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">ExAllocatePoolWithTag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NonPagedPoolNx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NPAGED_LOOKASIDE_LIST&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">memset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NPAGED_LOOKASIDE_LIST&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// init
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ExInitializeNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bInit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// start allocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ExAllocateFromNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pSeocdeMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ExAllocateFromNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pSeocdeMemory&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] First Address:%p, Second Address:%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pFirstMemory&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pSeocdeMemory&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// free first
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ExFreeToNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pFirstMemory&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// reallocate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ExAllocateFromNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Re-Allocate First Address:%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pFirstMemory&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bSucc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExFreeToNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pFirstMemory&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pFirstMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pSeocdeMemory&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExFreeToNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pSeocdeMemory&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pSeocdeMemory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bInit&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExDeleteNPagedLookasideList&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bInit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ExFreePoolWithTag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pLookAsideList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pLookAsideList&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="对象与句柄">对象与句柄&lt;/h2>
&lt;blockquote>
&lt;p>在内核中创建，在内核中销毁，由内核管理与维护的对象称为内核对象&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">TestFuncObject&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BOOLEAN&lt;/span> &lt;span class="n">bSucc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">HANDLE&lt;/span> &lt;span class="n">hCreateEvent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">pCreateEventObject&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">HANDLE&lt;/span> &lt;span class="n">hOpenEvent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">PVOID&lt;/span> &lt;span class="n">pOpenEventObject&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">OBJECT_ATTRIBUTES&lt;/span> &lt;span class="n">ObjAttr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">UNICODE_STRING&lt;/span> &lt;span class="n">uNameString&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">RtlInitUnicodeString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uNameString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="sa">L&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s">BaseNamedObjects&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s">TestEvent&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">InitializeObjectAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ObjAttr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">uNameString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">OBJ_KERNEL_HANDLE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">OBJ_CASE_INSENSITIVE&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZwCreateEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">hCreateEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EVENT_ALL_ACCESS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ObjAttr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">SynchronizationEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hCreateEvent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// get point
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ObReferenceObjectByHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hCreateEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EVENT_ALL_ACCESS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ExEventObjectType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KernelMode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">pCreateEventObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pCreateEventObject&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// open obj with attribute:name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ZwOpenEvent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">hOpenEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EVENT_ALL_ACCESS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">ObjAttr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hOpenEvent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ObReferenceObjectByHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hOpenEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">EVENT_ALL_ACCESS&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ExEventObjectType&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">KernelMode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">pOpenEventObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pOpenEventObject&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Create Handle:%p, Create Object Address:%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hCreateEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pCreateEventObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Open Handle:%p, Open Object Address:%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hOpenEvent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">pOpenEventObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bSucc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TRUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">FALSE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pCreateEventObject&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ObDereferenceObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pCreateEventObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pCreateEventObject&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hCreateEvent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZwClose&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hCreateEvent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hCreateEvent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pOpenEventObject&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ObDereferenceObject&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pOpenEventObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pOpenEventObject&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">hOpenEvent&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ZwClose&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hOpenEvent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hOpenEvent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>一个小小的坑：在导入头文件的时候发生冲突：&lt;code>ntddk.h&lt;/code>和&lt;code>ntifs.h&lt;/code>，解决办法是将&lt;code>ntifs.h&lt;/code>放到&lt;code>ntddk.h&lt;/code>的前面导入，这样就没有冲突了&lt;/p>
&lt;/blockquote>
&lt;h2 id="注册表">注册表&lt;/h2>
&lt;blockquote>
&lt;p>注册表其实是Windows的配置存储结构，存储着系统绝大部分的配置信息，其中大多数文件存储在系统盘下SYSTEM32\CONFIG目录下，这些文件以内存映射方式存储在内核空间中，然后以“HIVE”的方式组织起来，注册表API实际上操作的是HIVE内存数据，最终会写回到config目录下对应的文件中去&lt;/p>
&lt;/blockquote>
&lt;h3 id="打开与关闭">打开与关闭&lt;/h3>
&lt;ul>
&lt;li>未完待续&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Windows内核学习笔记-001</title><link>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001/</link><pubDate>Fri, 18 Dec 2020 18:52:00 +0800</pubDate><guid>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001/</guid><description>&lt;p>本文来源：&lt;a class="link" href="https://blog.moeomu.com/zh-cn/posts/windows%e5%86%85%e6%a0%b8%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0-001/" >Moeomu的博客&lt;/a>&lt;/p>
&lt;h2 id="windows内核开发环境配置">Windows内核开发环境配置&lt;/h2>
&lt;h3 id="下载">下载&lt;/h3>
&lt;blockquote>
&lt;p>开发机&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Windows 10 20H2 x64&lt;/li>
&lt;li>Visual Studio 2019&lt;/li>
&lt;li>Windows Driver Kit - Windows 10.0.19041.685(Windows 10 2004)&lt;/li>
&lt;li>WinDbg Preview&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>测试机&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>Windows 10 2004 x64&lt;/li>
&lt;li>DbgView&lt;/li>
&lt;/ul>
&lt;h3 id="测试驱动程序">测试驱动程序&lt;/h3>
&lt;blockquote>
&lt;p>还是使用最经典的HelloWorld来作为开始吧&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;ntddk.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VOID&lt;/span> &lt;span class="nf">DriverUnload&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PDRIVER_OBJECT&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Unload, Driver Object Address: %p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">NTSTATUS&lt;/span> &lt;span class="nf">DriverEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PDRIVER_OBJECT&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PUNICODE_STRING&lt;/span> &lt;span class="n">RegistryPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Hello Kernel World!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DriverObject&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Object Address: %p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DriverObject&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">DriverUnload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">DriverUnload&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">RegistryPath&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Registry Path: %wZ&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RegistryPath&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">STATUS_SUCCESS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="测试调试">测试调试&lt;/h3>
&lt;blockquote>
&lt;p>参考&lt;a class="link" href="https://blog.moeomu.com/posts/Windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" >Windows内核调试&lt;/a>一文来布置调试环境，只不过将Windows7的地方改成Windows10即可&lt;/p>
&lt;/blockquote>
&lt;h2 id="上下文环境解析">上下文环境解析&lt;/h2>
&lt;blockquote>
&lt;p>上下文指的是CPU在执行代码时，改代码所处的环境与状态。&lt;/p>
&lt;/blockquote>
&lt;h3 id="实验psgetcurrentprocessid">实验：PsGetCurrentProcessId&lt;/h3>
&lt;blockquote>
&lt;p>实验目的是为了找出所写出的驱动模块究竟在哪个“进程”中执行&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C" data-lang="C">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;ntddk.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">VOID&lt;/span> &lt;span class="nf">DriverUnload&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PDRIVER_OBJECT&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Unload, Driver Object Address: %p, Current Process Id=0x%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PsGetCurrentProcessId&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">NTSTATUS&lt;/span> &lt;span class="nf">DriverEntry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PDRIVER_OBJECT&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PUNICODE_STRING&lt;/span> &lt;span class="n">RegistryPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Hello Kernel World, Current Process Id=0x%p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PsGetCurrentProcessId&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">DriverObject&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Object Address: %p&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DriverObject&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DriverObject&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">DriverUnload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">DriverUnload&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">RegistryPath&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">DbgPrint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;[%ws] Driver Registry Path: %wZ&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__FUNCTIONW__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RegistryPath&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">STATUS_SUCCESS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>如图&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://s3.ax1x.com/2020/12/18/rYh5BF.png"
loading="lazy"
alt="rYh5BF.png"
>
&lt;img src="https://s3.ax1x.com/2020/12/18/rYhq91.png"
loading="lazy"
alt="rYhq91.png"
>&lt;/p>
&lt;h3 id="结论">结论&lt;/h3>
&lt;blockquote>
&lt;p>无论是驱动入口函数还是驱动卸载回调函数都隶属于ID为4的进程，此进程为System进程&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>System进程是操作系统虚拟出来的一个进程，代表系统内核&lt;/li>
&lt;li>驱动和应用层上下文应当严格区分，若进程A运行在P1虚拟空间内，而驱动当前的CPU上下文是P2的虚拟空间，那么访问到的内容应当是不可预料的&lt;/li>
&lt;/ul>
&lt;h2 id="中断请求级别">中断请求级别&lt;/h2>
&lt;blockquote>
&lt;p>与线程的优先级的概念类似，系统调度器以时间片为粒度调度，根据线程的优先级来调度线程，线程优先级越高，获得调度的机会越大。而在驱动层，CPU提供了IRQL的概念，规定高IRQL级别的代码可以中断、抢占低IRQL的代码的执行过程，从而执行。&lt;/p>
&lt;/blockquote>
&lt;h3 id="常见的irql中断请求级别表">常见的IRQL中断请求级别表&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>IRQL&lt;/th>
&lt;th>数值(x86, amd64, IA64)&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>PASSIVE_LEVEL&lt;/td>
&lt;td>0, 0, 0&lt;/td>
&lt;td>应用层线程以及大部分内核函数处于该IRQL，可与无限制使用所有内核API，可以访问分页以及非分页内存&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>APC_LEVEL&lt;/td>
&lt;td>1, 1, 1&lt;/td>
&lt;td>异步方法调用(APC)，或者页错误时处于该IRQL，可以使用大部分内核API，可以访问分页以及非分页内存&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DISPATCH_LEVEL&lt;/td>
&lt;td>2, 2, 2&lt;/td>
&lt;td>延迟方法调用(DPC)时处于该IRQL，可以使用特定的内核API，只能访问非分页内存&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="判断当前irql">判断当前IRQL&lt;/h3>
&lt;ul>
&lt;li>在驱动程序入口点DriverEntry，IRQL为PASSIVE_LEVEL，这是系统保证的&lt;/li>
&lt;li>通过调用KeGetCurrentIrql函数来获取当前的IRQL&lt;/li>
&lt;li>如图所示，IRQL都是0，对照上表，级别是PASSIVE_LEVEL&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://s3.ax1x.com/2020/12/18/rYHLIU.png"
loading="lazy"
alt="rYHLIU.png"
>]&lt;/p>
&lt;h3 id="结论-1">结论&lt;/h3>
&lt;ul>
&lt;li>在调用某个函数之前首先看清楚函数说明文档，仔细观察安全调用函数的IRQL级别是什么，以此来实现安全编程&lt;/li>
&lt;/ul>
&lt;h2 id="驱动异常">驱动异常&lt;/h2>
&lt;blockquote>
&lt;p>开发驱动时，若驱动程序代码编写不合规引发系统崩溃的情况，表现为蓝屏(BSOD)。&lt;/p>
&lt;/blockquote>
&lt;h3 id="常见原因">常见原因&lt;/h3>
&lt;ul>
&lt;li>高IRQL死锁&lt;/li>
&lt;li>内存访问违规&lt;/li>
&lt;li>函数堆栈不平衡&lt;/li>
&lt;/ul>
&lt;h3 id="主动引发蓝屏">主动引发蓝屏&lt;/h3>
&lt;ul>
&lt;li>可以使用KeBugCheckEx函数主动引发蓝屏&lt;/li>
&lt;/ul>
&lt;h3 id="结论-2">结论&lt;/h3>
&lt;ul>
&lt;li>在代码发生不可预知错误时，主动引发蓝屏可以减少进一步扩大错误&lt;/li>
&lt;/ul></description></item><item><title>Windows内核调试学习笔记-002-结构体</title><link>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-002-%E7%BB%93%E6%9E%84%E4%BD%93/</link><pubDate>Sat, 17 Oct 2020 20:23:00 +0800</pubDate><guid>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-002-%E7%BB%93%E6%9E%84%E4%BD%93/</guid><description>&lt;p>本文来源：&lt;a class="link" href="https://blog.moeomu.com/zh-cn/posts/windows%e5%86%85%e6%a0%b8%e8%b0%83%e8%af%95%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0-002-%e7%bb%93%e6%9e%84%e4%bd%93/" >Moeomu的博客&lt;/a>&lt;/p>
&lt;h2 id="非公开内核结构">非公开内核结构&lt;/h2>
&lt;p>Windows的非公开结构非常多，而有些结构是半公开的，虽然有字段名，但只能推测其用意&lt;br>
WinDbg能加载一些内核调试符号，在这些PDB文件中，有一些半公开结构的信息&lt;/p>
&lt;hr>
&lt;h2 id="eprocesskpebkernel-process-environment-block">EPROCESS(KPEB)(Kernel Process Environment Block)&lt;/h2>
&lt;p>每一个进程都由一个EPROCESS结构表示，而这些结构被一个双向链表所连接&lt;/p>
&lt;h3 id="结构信息">结构信息&lt;/h3>
&lt;ul>
&lt;li>0x000偏移是PCB(Process Control Block)的地址，它位于R0中&lt;/li>
&lt;li>0x0b4偏移是PID，它是标识此进程的唯一标识符&lt;/li>
&lt;li>0x0b8偏移是活动进程链表，可以用它遍历系统的所有EPROCESS结构&lt;/li>
&lt;/ul>
&lt;h3 id="结构组成">结构组成&lt;/h3>
&lt;blockquote>
&lt;p>以下是此结构的详细内容&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">kd&amp;gt; dt _eprocess
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nt!_EPROCESS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x000 Pcb : _KPROCESS // 进程控制块
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x098 ProcessLock : _EX_PUSH_LOCK // 进程锁
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0a0 CreateTime : _LARGE_INTEGER // 创建时间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0a8 ExitTime : _LARGE_INTEGER // 退出时间
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b0 RundownProtect : _EX_RUNDOWN_REF // 进程加保护
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b4 UniqueProcessId : Ptr32 Void // PID
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b8 ActiveProcessLinks : _LIST_ENTRY // 活动进程链表
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0c0 ProcessQuotaUsage : [2] Uint4B // 物理页相关的统计信息
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0c8 ProcessQuotaPeak : [2] Uint4B // 物理页相关的统计信息
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0d0 CommitCharge : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0d4 QuotaBlock : Ptr32 _EPROCESS_QUOTA_BLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0d8 CpuQuotaBlock : Ptr32 _PS_CPU_QUOTA_BLOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0dc PeakVirtualSize : Uint4B // 虚拟内存池大小
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0e0 VirtualSize : Uint4B // 虚拟内存大小
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0e4 SessionProcessLinks : _LIST_ENTRY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0ec DebugPort : Ptr32 Void // 调试端口
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0f0 ExceptionPortData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0f0 ExceptionPortValue : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0f0 ExceptionPortState : Pos 0, 3 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0f4 ObjectTable : Ptr32 _HANDLE_TABLE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0f8 Token : _EX_FAST_REF // 权限令牌的地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0fc WorkingSetPage : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x100 AddressCreationLock : _EX_PUSH_LOCK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x104 RotateInProgress : Ptr32 _ETHREAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x108 ForkInProgress : Ptr32 _ETHREAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x10c HardwareTrigger : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x110 PhysicalVadRoot : Ptr32 _MM_AVL_TABLE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x114 CloneRoot : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x118 NumberOfPrivatePages : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x11c NumberOfLockedPages : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x120 Win32Process : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x124 Job : Ptr32 _EJOB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x128 SectionObject : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x12c SectionBaseAddress : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x130 Cookie : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x134 Spare8 : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x138 WorkingSetWatch : Ptr32 _PAGEFAULT_HISTORY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x13c Win32WindowStation : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x140 InheritedFromUniqueProcessId : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x144 LdtInformation : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x148 VdmObjects : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x14c ConsoleHostProcess : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x150 DeviceMap : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x154 EtwDataSource : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x158 FreeTebHint : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x160 PageDirectoryPte : _HARDWARE_PTE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x160 Filler : Uint8B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x168 Session : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x16c ImageFileName : [15] UChar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x17b PriorityClass : UChar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x17c JobLinks : _LIST_ENTRY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x184 LockedPagesList : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x188 ThreadListHead : _LIST_ENTRY // ETHREAD结构链表头
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x190 SecurityPort : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x194 PaeTop : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x198 ActiveThreads : Uint4B // 正在运行的线程数量
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x19c ImagePathHash : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1a0 DefaultHardErrorProcessing : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1a4 LastThreadExitStatus : Int4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1a8 Peb : Ptr32 _PEB // 进程环境块地址
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1ac PrefetchTrace : _EX_FAST_REF
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1b0 ReadOperationCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1b8 WriteOperationCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1c0 OtherOperationCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1c8 ReadTransferCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1d0 WriteTransferCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1d8 OtherTransferCount : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1e0 CommitChargeLimit : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1e4 CommitChargePeak : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1e8 AweInfo : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1ec SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1f0 Vm : _MMSUPPORT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x25c MmProcessLinks : _LIST_ENTRY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x264 HighestUserAddress : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x268 ModifiedPageCount : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c Flags2 : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c JobNotReallyActive : Pos 0, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c AccountingFolded : Pos 1, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c NewProcessReported : Pos 2, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ExitProcessReported : Pos 3, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ReportCommitChanges : Pos 4, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c LastReportMemory : Pos 5, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ReportPhysicalPageChanges : Pos 6, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c HandleTableRundown : Pos 7, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c NeedsHandleRundown : Pos 8, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c RefTraceEnabled : Pos 9, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c NumaAware : Pos 10, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ProtectedProcess : Pos 11, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c DefaultPagePriority : Pos 12, 3 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c PrimaryTokenFrozen : Pos 15, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ProcessVerifierTarget : Pos 16, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c StackRandomizationDisabled : Pos 17, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c AffinityPermanent : Pos 18, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c AffinityUpdateEnable : Pos 19, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c PropagateNode : Pos 20, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x26c ExplicitAffinity : Pos 21, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 Flags : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 CreateReported : Pos 0, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 NoDebugInherit : Pos 1, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ProcessExiting : Pos 2, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ProcessDelete : Pos 3, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 Wow64SplitPages : Pos 4, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 VmDeleted : Pos 5, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 OutswapEnabled : Pos 6, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 Outswapped : Pos 7, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ForkFailed : Pos 8, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 Wow64VaSpace4Gb : Pos 9, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 AddressSpaceInitialized : Pos 10, 2 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 SetTimerResolution : Pos 12, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 BreakOnTermination : Pos 13, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 DeprioritizeViews : Pos 14, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 WriteWatch : Pos 15, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ProcessInSession : Pos 16, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 OverrideAddressSpace : Pos 17, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 HasAddressSpace : Pos 18, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 LaunchPrefetched : Pos 19, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 InjectInpageErrors : Pos 20, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 VmTopDown : Pos 21, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ImageNotifyDone : Pos 22, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 PdeUpdateNeeded : Pos 23, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 VdmAllowed : Pos 24, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 CrossSessionCreate : Pos 25, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ProcessInserted : Pos 26, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 DefaultIoPriority : Pos 27, 3 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 ProcessSelfDelete : Pos 30, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x270 SetTimerResolutionLink : Pos 31, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x274 ExitStatus : Int4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x278 VadRoot : _MM_AVL_TABLE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x298 AlpcContext : _ALPC_PROCESS_CONTEXT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x2a8 TimerResolutionLink : _LIST_ENTRY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x2b0 RequestedTimerResolution : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x2b4 ActiveThreadsHighWatermark : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x2b8 SmallestTimerResolution : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x2bc TimerResolutionStackRecord : Ptr32 _PO_DIAG_STACK_RECORD
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;h2 id="pebprocess-environment-block">PEB(Process Environment Block)&lt;/h2>
&lt;p>此结构位于R3层，相对容易修改&lt;/p>
&lt;h3 id="结构信息-1">结构信息&lt;/h3>
&lt;ul>
&lt;li>0x002偏移是是否被调试的FLAG的位置，这个值在R3下即可被修改&lt;/li>
&lt;li>0x068偏移此值平时是0，被调试时是0x70&lt;/li>
&lt;li>0x018偏移是_HEAP结构的地址，此结构体内可以判断在偏移0x40=2和0x44=0时为非调试状态&lt;/li>
&lt;/ul>
&lt;h3 id="结构组成-1">结构组成&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">kd&amp;gt; dt _PEB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nt!_PEB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x000 InheritedAddressSpace : UChar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x001 ReadImageFileExecOptions : UChar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x002 BeingDebugged : UChar // 是否被调试
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 BitField : UChar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 ImageUsesLargePages : Pos 0, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 IsProtectedProcess : Pos 1, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 IsLegacyProcess : Pos 2, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 IsImageDynamicallyRelocated : Pos 3, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 SkipPatchingUser32Forwarders : Pos 4, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x003 SpareBits : Pos 5, 3 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x004 Mutant : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x008 ImageBaseAddress : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x00c Ldr : Ptr32 _PEB_LDR_DATA // 进程装载的模块结构体
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x010 ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x014 SubSystemData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x018 ProcessHeap : _HEAP // 0x40=2&amp;amp;&amp;amp;0x44=0为非调试状态
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x01c FastPebLock : Ptr32 _RTL_CRITICAL_SECTION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x020 AtlThunkSListPtr : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x024 IFEOKey : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 CrossProcessFlags : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ProcessInJob : Pos 0, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ProcessInitializing : Pos 1, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ProcessUsingVEH : Pos 2, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ProcessUsingVCH : Pos 3, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ProcessUsingFTH : Pos 4, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x028 ReservedBits0 : Pos 5, 27 Bits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x02c KernelCallbackTable : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x02c UserSharedInfoPtr : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x030 SystemReserved : [1] Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x034 AtlThunkSListPtr32 : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x038 ApiSetMap : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x03c TlsExpansionCounter : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x040 TlsBitmap : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x044 TlsBitmapBits : [2] Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x04c ReadOnlySharedMemoryBase : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x050 HotpatchInformation : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x054 ReadOnlyStaticServerData : Ptr32 Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x058 AnsiCodePageData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x05c OemCodePageData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x060 UnicodeCaseTableData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x064 NumberOfProcessors : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x068 NtGlobalFlag : Uint4B // 反调试用
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x070 CriticalSectionTimeout : _LARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x078 HeapSegmentReserve : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x07c HeapSegmentCommit : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x080 HeapDeCommitTotalFreeThreshold : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x084 HeapDeCommitFreeBlockThreshold : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x088 NumberOfHeaps : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x08c MaximumNumberOfHeaps : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x090 ProcessHeaps : Ptr32 Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x094 GdiSharedHandleTable : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x098 ProcessStarterHelper : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x09c GdiDCAttributeList : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0a0 LoaderLock : Ptr32 _RTL_CRITICAL_SECTION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0a4 OSMajorVersion : Uint4B // 系统主版本号
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0a8 OSMinorVersion : Uint4B // 系统子版本号
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0ac OSBuildNumber : Uint2B // 系统构建版本号
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0ae OSCSDVersion : Uint2B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b0 OSPlatformId : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b4 ImageSubsystem : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0b8 ImageSubsystemMajorVersion : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0bc ImageSubsystemMinorVersion : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0c0 ActiveProcessAffinityMask : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x0c4 GdiHandleBuffer : [34] Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x14c PostProcessInitRoutine : Ptr32 void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x150 TlsExpansionBitmap : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x154 TlsExpansionBitmapBits : [32] Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1d4 SessionId : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1d8 AppCompatFlags : _ULARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1e8 pShimData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1ec AppCompatInfo : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1f0 CSDVersion : _UNICODE_STRING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1f8 ActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x1fc ProcessAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x200 SystemDefaultActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x204 SystemAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x208 MinimumStackCommit : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x20c FlsCallback : Ptr32 _FLS_CALLBACK_INFO
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x210 FlsListHead : _LIST_ENTRY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x218 FlsBitmap : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x21c FlsBitmapBits : [4] Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x22c FlsHighIndex : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x230 WerRegistrationData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x234 WerShipAssertPtr : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x238 pContextData : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x23c pImageHeaderHash : Ptr32 Void
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x240 TracingFlags : Uint4B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x240 HeapTracingEnabled : Pos 0, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x240 CritSecTracingEnabled : Pos 1, 1 Bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +0x240 SpareTracingBits : Pos 2, 30 Bits
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;h2 id="参考文档">参考文档&lt;/h2>
&lt;p>[1]Infosavvy.Understanding EProcess Structure[J/OL].2020-07-24&lt;/p></description></item><item><title>Windows内核调试学习笔记-001-环境搭建</title><link>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</link><pubDate>Sat, 17 Oct 2020 19:27:00 +0800</pubDate><guid>https://blog.moeomu.com/zh-cn/posts/windows%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-001-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</guid><description>&lt;p>本文来源：&lt;a class="link" href="https://blog.moeomu.com/zh-cn/posts/windows%e5%86%85%e6%a0%b8%e8%b0%83%e8%af%95%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0-001-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba/" >Moeomu的博客&lt;/a>&lt;/p>
&lt;h2 id="下载工具">下载工具&lt;/h2>
&lt;ul>
&lt;li>Windows 7 SP1 x86 &lt;a class="link" href="thunder://QUFlZDJrOi8vfGZpbGV8Y25fd2luZG93c183X3VsdGltYXRlX3dpdGhfc3AxX3g4Nl9kdmRfdV82Nzc0ODYuaXNvfDI2NTMyNzYxNjB8NzUwM0U0QjlCODczOERGQ0I5NTg3MjQ0NUM3MkFFRkJ8L1pa" >镜像迅雷下载链接&lt;/a>&lt;/li>
&lt;li>VMWare Workstation 16(链接在下方)&lt;/li>
&lt;li>WinDbg Preview(&lt;a class="link" href="https://www.microsoft.com/zh-cn/p/windbg-preview/9pgjgd53tn86" target="_blank" rel="noopener"
>Microsoft Store&lt;/a>)&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="安装windows虚拟机">安装Windows虚拟机&lt;/h2>
&lt;blockquote>
&lt;p>最初以Windows 7 SP1 x86为例子来学习&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>MSDN下载官方镜像&lt;/li>
&lt;li>VMWare Workstation 16搭建虚拟环境
&lt;ul>
&lt;li>下载：&lt;a class="link" href="https://www.vmware.com/go/getworkstation-win" target="_blank" rel="noopener"
>VMWare 16 Link&lt;/a>&lt;/li>
&lt;li>密钥：&lt;code>ZF3R0-FHED2-M80TY-8QYGC-NPKYF&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="配置windows内核调试虚拟机">配置Windows内核调试虚拟机&lt;/h2>
&lt;h3 id="移除此虚拟机的打印机设备">移除此虚拟机的打印机设备&lt;/h3>
&lt;h3 id="添加串行串口">添加串行串口&lt;/h3>
&lt;ul>
&lt;li>点击使用命名的管道&lt;/li>
&lt;li>填入字符串：&lt;code>\\.\pipe\Windows7x86&lt;/code>(可以填入自己希望的管道命名，但是只能修改&lt;code>Windows7x86&lt;/code>位置处)&lt;/li>
&lt;li>下方选择该端是服务器，另一端是应用程序&lt;/li>
&lt;li>I/O模式中，选择&lt;code>轮询时主动放弃&lt;/code>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>配置完成如下图所示&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://s1.ax1x.com/2020/10/18/0j8UKI.png"
loading="lazy"
alt="虚拟机配置图.png"
>&lt;/p>
&lt;h3 id="配置windows7">配置Windows7&lt;/h3>
&lt;ul>
&lt;li>输入命令&lt;code>msconfig&lt;/code>，点击引导，如图&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://s1.ax1x.com/2020/10/18/0jGpJe.png"
loading="lazy"
alt="引导.jpg"
>&lt;/p>
&lt;ul>
&lt;li>点击高级选项，启用调试，波特率，如图&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://s1.ax1x.com/2020/10/18/0jGSiD.png"
loading="lazy"
alt="高级选项.jpg"
>&lt;/p>
&lt;hr>
&lt;h2 id="配置windbg-preview">配置WinDbg Preview&lt;/h2>
&lt;ul>
&lt;li>首先启动代理网络，用于解除GFW限制&lt;/li>
&lt;li>设置WinDbg的符号服务器和本地缓存目录&lt;code>SRV*D:\LocalSymbols*http://msdl.microsoft.com/download/symbols&lt;/code>&lt;/li>
&lt;li>Attach to kernel-COM-能选的对勾都选上-填波特率-Port填&lt;code>\\.\pipe\Windows7x86&lt;/code>&lt;/li>
&lt;li>点击OK以调试虚拟机内核&lt;/li>
&lt;li>设置WinDbg的符号服务器代理&lt;code>set _NT_SYMBOL_PROXY=代理服务器地址:端口号&lt;/code>&lt;/li>
&lt;/ul></description></item></channel></rss>